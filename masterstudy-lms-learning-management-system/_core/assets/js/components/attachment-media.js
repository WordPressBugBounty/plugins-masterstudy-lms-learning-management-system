"use strict";function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function ownKeys(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,a)}return s}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(s),!0).forEach((function(t){_defineProperty(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):ownKeys(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}function _defineProperty(e,t,s){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var a=s.call(e,t||"default");if("object"!=_typeof(a))return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}!function(e){e(document).ready((function(){var t=[],s=[],a=!1,r=1,d=1,i=ms_lms_resturl+"/media",n=media_data.message,o=e('[data-id="masterstudy-file-upload-field"]'),u=e('[data-id="masterstudy-audio-recorder"]'),m=e('[data-id="masterstudy-video-recorder"]'),c=e("[data-id='assignment_file_alert']"),l=e('.masterstudy-button[data-id="masterstudy-review-submit"]');function _(e){e.preventDefault(),c.removeClass("masterstudy-alert_open")}e("body").addClass("masterstudy-user-assignment__single"),e(document).on("click",".masterstudy-file-attachment__delete",(function(t){var s,a;t.preventDefault(),c.addClass("masterstudy-alert_open"),s=this,a=e(this).data("id"),c.find("[data-id='submit']").click((function(t){t.preventDefault(),e.ajax({type:"POST",url:ajaxurl,data:{action:"stm_lms_delete_assignment_attachment",attachment_id:a,post_id:media_data.assignment_id,nonce:ms_lms_nonce,is_review:media_data.is_review},beforeSend:function(){c.removeClass("masterstudy-alert_open")},success:function(t){!0===t.success&&e(s).parents(".masterstudy-file-attachment").remove()}})}))})),c.find("[data-id='cancel']").click(_),c.find(".masterstudy-alert__header-close").click(_),MasterstudyAudioPlayer.init({selector:".masterstudy-audio-player",showDeleteButton:!1}),u.on("click",(function(d){if(d.preventDefault(),!e(this).hasClass("masterstudy-button_disabled")){var c=p();if(1*media_data.files_max_number>0&&c>=1*media_data.files_max_number)y(n.file.number_error,"error");else{var _=new MasterstudyAudioRecorder(".masterstudy-audio__recorder",{isHidden:!0,directRecording:!0,darkMode:media_data.dark_mode}),f=e(".masterstudy-audio__recorder");if(_.startRecording().then((function(e){a=!e,e?f.removeClass("masterstudy-audio__recorder_hidden"):(y(n.audio.permission,"error"),h([u,o,m,l]))})),h([u,o,m,l]),a)return!1;e('.masterstudy-message[data-id="message-box"]').addClass("masterstudy-message_hidden"),a=!0;var v=e(".masterstudy-attachment-media .masterstudy-progress");v.find(".masterstudy-progress__bar-filled").css("width","0%"),_.addAction("beforeStop",(function(e){e.hideRecorder(),v.removeClass("masterstudy-progress_hidden")})),_.addAction("onStop",(function(d,c,_){if(a=!1,c&&-1===s.indexOf(c.id)){s.push(c.id);var p=c.id.slice(-6)+r,b=window.URL.createObjectURL(d),w=media_data.assignment_id,x="audio-attachment-".concat(w,"-").concat(p,".mp3"),C=new File([d],x,{type:d.type});r++;var O=new FormData;if(O.append("file",C),f.addClass("masterstudy-audio__recorder_hidden"),d.size)if(d.size/1048576>1*media_data.audio_max_size)return y(n.audio.size_error,"error",n.audio.download,b),void h([u,o,m,l]);e.ajax({url:i,type:"POST",data:O,processData:!1,contentType:!1,xhr:function(){var e=new window.XMLHttpRequest;return e.upload.addEventListener("progress",(function(e){if(e.lengthComputable){var t=Math.round(e.loaded/e.total*100);t=t>=95?95:t,v.find(".masterstudy-progress__percent").text(t),v.find(".masterstudy-progress__bar-filled").css("width",t+"%")}}),!1),e},headers:{"X-WP-Nonce":ms_lms_nonce,Accept:"application/json"},error:function(e,t,s){y(n.error.text,"error",n.audio.download,b),h([u,o,m,l])},complete:function(e,s){"success"===s?(setTimeout((function(){v.find(".masterstudy-progress__percent").text(100),v.find(".masterstudy-progress__bar-filled").css("width","100%")}),1e3),setTimeout((function(){var s=e.responseJSON;v.addClass("masterstudy-progress_hidden"),s&&s.id>0&&-1===t.indexOf(s.id)&&(t.push(s.id),g(s,!0))}),1500)):(y(n.error.text,"error",n.audio.download,b),h([u,o,m,l]))}})}}))}}})),m.on("click",(function(r){if(r.preventDefault(),!e(this).hasClass("masterstudy-button_disabled")){var c=p();if(1*media_data.files_max_number>0&&c>=1*media_data.files_max_number)y(n.file.number_error,"error");else{var _=new MasterstudyVideoRecoder(".masterstudy-video__recorder",{isHidden:!0,clearSource:!0});if(_.startRecording().then((function(e){a=!e,e?_.showRecorder():(y(n.video.permission,"error"),h([u,o,m,l]))})),h([u,o,m,l]),a)return!1;e('.masterstudy-message[data-id="message-box"]').addClass("masterstudy-message_hidden"),a=!0,_.addAction("onStop",(function(r,c,f){if(_.hideRecorder(),a=!1,c&&-1===s.indexOf(c.id)){s.push(c.id);var p=c.id.slice(-6)+d,v=window.URL.createObjectURL(r),b=media_data.assignment_id,w="video-attachment-".concat(b,"-").concat(p,".mp4"),x=new File([r],w,{type:r.type});d++;var C=new FormData;if(C.append("file",x),r.size)if(r.size/1048576>1*media_data.video_max_size)return y(n.video.size_error,"error",n.video.download,v),void h([u,o,m,l]);var O=e(".masterstudy-attachment-media .masterstudy-progress");O.removeClass("masterstudy-progress_hidden"),O.find(".masterstudy-progress__bar-filled").css("width","0%"),e.ajax({url:i,type:"POST",data:C,processData:!1,contentType:!1,xhr:function(){var e=new window.XMLHttpRequest;return e.upload.addEventListener("progress",(function(e){if(e.lengthComputable){var t=Math.round(e.loaded/e.total*100);t=t>=95?95:t,O.find(".masterstudy-progress__percent").text(t),O.find(".masterstudy-progress__bar-filled").css("width",t+"%")}}),!1),e},headers:{"X-WP-Nonce":ms_lms_nonce,Accept:"application/json"},error:function(e,t,s){y(n.error.text,"error",n.video.download,v),h([u,o,m,l])},complete:function(e,s){"success"===s?(setTimeout((function(){O.find(".masterstudy-progress__percent").text(100),O.find(".masterstudy-progress__bar-filled").css("width","100%")}),1e3),setTimeout((function(){var s=e.responseJSON;O.addClass("masterstudy-progress_hidden"),s&&s.id>0&&-1===t.indexOf(s.id)&&(t.push(s.id),g(s,!0))}),1500)):(y(n.error.text,"error",n.video.download,v),h([u,o,m,l]))}})}}))}}})),o.on("click",(function(t){t.preventDefault(),e(this).hasClass("masterstudy-button_disabled")||e(".masterstudy-file-upload__input").click()})),e(".masterstudy-file-upload__input").on("change",(function(s){e('.masterstudy-message[data-id="message-box"]').addClass("masterstudy-message_hidden");var a=Array.from(s.target.files),r=media_data.files_extensions.split(",").map((function(e){return e.trim().toLowerCase()})),d=p()+a.length;if(1*media_data.files_max_number>0&&d>1*media_data.files_max_number)y(n.file.number_error,"error");else if(0!==a.length){var c=e(".masterstudy-attachment-media .masterstudy-progress");c.removeClass("masterstudy-progress_hidden"),c.find(".masterstudy-progress__percent").text(0),c.find(".masterstudy-progress__bar-filled").css("width","0%");var _=Array.from(a).reduce((function(e,t){return e+t.size}),0),f=0;a.forEach((function(s){h([u,o,m,l]);var d=s.name.split(".").pop().toLowerCase();if(1*media_data.files_max_size>0&&s.size>1*media_data.files_max_size*1024*1024)return y(n.file.size_error,"error"),void h([u,o,m,l]);if(!r.includes(d))return y(n.file.extension,"error"),void h([u,o,m,l]);var p=new FormData;p.append("file",s),e.ajax({url:i,type:"POST",data:p,processData:!1,contentType:!1,xhr:function(){var e=new window.XMLHttpRequest;return e.upload.addEventListener("progress",(function(e){if(e.lengthComputable&&1===a.length){var t=Math.round(e.loaded/e.total*100);c.find(".masterstudy-progress__percent").text(t),c.find(".masterstudy-progress__bar-filled").css("width",t+"%")}})),e},headers:{"X-WP-Nonce":ms_lms_nonce,Accept:"application/json"},success:function(e){e&&e.id?e.id>0&&-1===t.indexOf(e.id)&&(t.push(e.id),f+=s.size,g(e,!0,1===a.length?100:Math.round(f/_*100))):(y(n.error.text,"error"),h([u,o,m,l]))},error:function(e,t,s){y(n.error.text,"error"),h([u,o,m,l])}})}))}}));var f=e(".masterstudy-radio-buttons").find("input:checked").val();function y(t){var s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success",a=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0,d=e('.masterstudy-message[data-id="message-box"]'),i=d.find(".masterstudy-message__icon"),n=d.find(".masterstudy-message__text"),o=d.find(".masterstudy-message__link"),u=e(".masterstudy-attachment-media .masterstudy-progress");i.attr("class",""),"success"===s?(d.removeClass("masterstudy-message_color-danger masterstudy-message_bg-danger"),d.addClass("masterstudy-message_color-success masterstudy-message_bg-success"),i.addClass("masterstudy-message__icon stmlms-check")):(e(".masterstudy-attachment-media .masterstudy-loader").hide(),u.addClass("masterstudy-progress_hidden"),d.removeClass("masterstudy-message_color-success masterstudy-message_bg-success"),d.addClass("masterstudy-message_color-danger masterstudy-message_bg-danger"),i.addClass("masterstudy-message__icon stmlms-warning"),a&&(o.html('<span class="stmlms-download"></span> '.concat(a)),o.attr("href",r),o.attr("download","assignment_review_media"))),n.html(t),e('.masterstudy-message[data-id="message-box"]').removeClass("masterstudy-message_hidden")}function p(){var t=e(".masterstudy-attachment-media__materials").find(".masterstudy-file-attachment");return t?t.length:0}function g(t,s,a){s=null!=s&&s;var r=0;"undefined"!=typeof assignments_data&&null!==assignments_data&&(r=assignments_data.course_id||0),e.ajax({type:"POST",url:ajaxurl,data:{action:"stm_lms_add_assignment_attachment",attachment:t,attachment_id:t.id,post_id:media_data.assignment_id,is_created:s,course_id:r,is_review:media_data.is_review,nonce:ms_lms_nonce},success:function(s){!0===s.success&&(!function(t,s){var a=t.url||t.source_url,r=function(e,t){var s=e.split(".").pop();for(var a in t)if(t[a].includes(s))return a;return"unknown"}(a,s.files_formats),d=t.title;"object"===_typeof(d)&&(d=t.title.raw);var i="";if(t.media_details){var n=Math.round(t.media_details.filesize/1024),o=n>1e3?"mb":"kb";i=(n=n>1e3?Math.round(n/1024):n)+" "+o}t.filesizeHumanReadable&&(i=t.filesizeHumanReadable.toLowerCase());var u=e('.masterstudy-attachment-media__actions [data-id="masterstudy-file-attachment__template"]').clone(),m=u.find(".masterstudy-audio-player"),c=u.find(".masterstudy-video__player");u.find("img").attr("src","".concat(s.icon_url+r,".svg")),u.find(".masterstudy-file-attachment__title").html(d),u.find(".masterstudy-file-attachment__size").html(i),u.find(".masterstudy-file-attachment__delete").attr("data-id",t.id),"audio"===r&&(m.attr("data-id","masterstudy-audio-player-".concat(t.id)),m.find("audio").attr("src",a),m.find("source").attr("src",a),m.find(".masterstudy-audio-player__download-link").attr("href",a),m.removeClass("masterstudy-audio-player_hidden"),c.addClass("masterstudy-video__player--hidden"));"video"===r&&(c.attr("src",a),c.find("source").attr("src",a),c.removeClass("masterstudy-video__player--hidden"),m.addClass("masterstudy-audio-player_hidden"));e(".masterstudy-attachment-media__materials").append(u.prop("outerHTML")),"audio"===r&&(document.querySelectorAll(".masterstudy-audio-player").forEach((function(e){e.audioInstance&&e.audioInstance.destroy(),e.removeAttribute("data-initialized")})),MasterstudyAudioPlayer.init({selector:'[data-id="masterstudy-audio-player-'.concat(t.id,'"]'),showDeleteButton:!1}))}(t,s.data),e(".masterstudy-attachment-media .masterstudy-loader").hide(),h([u,o,m,l]))},complete:function(){if(a&&"number"==typeof a){var t=e(".masterstudy-attachment-media .masterstudy-progress"),s=t.find(".masterstudy-progress__percent").text();a=(a=s<a?a:+s)>100?100:a,t.find(".masterstudy-progress__percent").text(a),t.find(".masterstudy-progress__bar-filled").css("width","".concat(a,"%")),100===a&&setTimeout((function(){t.addClass("masterstudy-progress_hidden")}),1500)}}})}function h(e,t){t=t||"masterstudy-button_disabled",e instanceof NodeList||e instanceof HTMLCollection||Array.isArray(e)?e.forEach((function(e){h(e)})):e.toggleClass(t)}null==f&&l.addClass("masterstudy-button_disabled"),e.each(e(".masterstudy-radio-buttons"),(function(t,s){e(s).on("click",(function(){l.removeClass("masterstudy-button_disabled")}))})),l.on("click",(function(t){if(t.preventDefault(),a)return!1;e('.masterstudy-message[data-id="message-box"]').addClass("masterstudy-message_hidden");var s=e(".masterstudy-wp-editor").find("textarea").val();f=e(".masterstudy-radio-buttons").find("input:checked").val();var r=e(".masterstudy-lms-assignment-grade__type").val(),d={};if(void 0!==r){var i=e(".masterstudy-lms-assignment-grade__field.field-".concat(r)).val();(d={"grade-type":r})[r]=i}if(void 0!==f&&(d={status:f}),d.length<1)return!1;h([u,o,m,l]),a=!0,e.ajax({type:"POST",url:ajaxurl,data:_objectSpread({action:"stm_lms_assignment_student_answer",review:s,nonce:ms_lms_nonce,assignment_id:media_data.assignment_id},d),success:function(e){!0===e.success?y(media_data.message.success.text):y(media_data.message.error.text,"error"),h([u,o,m,l]),a=!1},error:function(e){y(media_data.message.error.text,"error"),h([u,o,m,l]),a=!1}})}))}))}(jQuery);