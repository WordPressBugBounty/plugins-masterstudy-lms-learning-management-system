"use strict";function _typeof(t){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_typeof(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,_toPropertyKey(i.key),i)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"==_typeof(e)?e:e+""}function _toPrimitive(t,e){if("object"!=_typeof(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var i=r.call(t,e||"default");if("object"!=_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}var MasterstudyVideoRecoder=function(){function t(e,r){_classCallCheck(this,t),this.recorder=e,this.options=r||{},"string"==typeof e&&(this.recorder=document.querySelector(e)),this.recorder&&(this.recorder.classList.add("masterstudy-video__recorder"),this.recorder.setAttribute("data-recording","false"),this.recorder.setAttribute("data-recorded","false"),this.controls={startRecorderBtn:"",startBtn:".masterstudy-video__recorder-btn__record",stopBtn:".masterstudy-video__recorder-btn__stop",pauseBtn:".masterstudy-video__recorder-btn__pause",resumeBtn:".masterstudy-video__recorder-btn__resume",deleteBtn:".masterstudy-video__recorder-btn__delete",microphoneBtn:".masterstudy-video__recorder-btn__microphone",videoRecorderInput:".masterstudy-video__recorder-video",videoPlayerInput:".masterstudy-video__recorder-player",videoTimeline:".masterstudy-video__recorder__timeline"},this.constraints={audio:!0,video:{facingMode:"user",width:{min:640,ideal:1280,max:1920},height:{min:480,ideal:720,max:1080}}},this.timerInterval,this.videoChunks=[],this.isRecording=!1,this.isStopped=!1,this.isMuted=!1,this.stopTimer=!1,this.startTime=Date.now(),this.videoType='video/mp4; codecs="avc1.42E01E, mp4a.40.2"',this.isHidden=this.options.isHidden||!1,this.clearSource=this.options.clearSource||!1,this.recorderActions=[],this.currentMediaStream=null,this.mediaStreamStopped=!1,this.isHidden?this.recorder.classList.add("masterstudy-video__recorder_hidden"):this.recorder.classList.remove("masterstudy-video__recorder_hidden"),this.setControls(this.options),this.startBtn=this.getControl(this.controls.startBtn),this.stopBtn=this.getControl(this.controls.stopBtn),this.pauseBtn=this.getControl(this.controls.pauseBtn),this.resumeBtn=this.getControl(this.controls.resumeBtn),this.deleteBtn=this.getControl(this.controls.deleteBtn),this.microphoneBtn=this.getControl(this.controls.microphoneBtn),this.startRecorderBtn=this.getControl(this.controls.startRecorderBtn),this.videoPlayerInput=this.getControl(this.controls.videoPlayerInput),this.videoRecorderInput=this.getControl(this.controls.videoRecorderInput),this.videoTimeline=this.getControl(this.controls.videoTimeline),this.setConstraints(this.options.constraints||{}))}return _createClass(t,[{key:"startRecording",value:function(){return this.clearSource&&(this.videoPlayerInput.src="",this.videoRecorderInput.src="",this.recorder.setAttribute("data-recording",!1),this.recorder.setAttribute("data-recorded",!1)),this.videoChunks=[],this.startVideoStream(this.videoStream.bind(this))}},{key:"recordVideo",value:function(t,e,r){"inactive"===t.state?(this.mediaStreamStopped||(this.isIOS()&&this.startVideoStream(this.videoStream.bind(this)),t.start()),this.isRecording=!0,this.isStopped=!1,this.stopTimer=!1,this.startTime=Date.now(),this.recorder.setAttribute("data-recording",!0),this.changeControlAttributes(this.startBtn,"recordAlt","Stop Recording"),this.changeControlAttributes(this.microphoneBtn,"record"),this.timerInterval=setInterval(this.updateRecordingTime.bind(this),1e3),this.doAction("onRecord",e,t,r)):this.stopBtn||this.isStopped||(this.stopRecording(t,e),this.isStopped=!0,this.recorder.setAttribute("data-recorded",!0),this.changeControlAttributes(this.startBtn,"camera","Start Recording"),this.isMuted?this.changeControlAttributes(this.microphoneBtn,"micMuted"):this.changeControlAttributes(this.microphoneBtn,"mic"))}},{key:"pauseRecording",value:function(t,e,r){"recording"===t.state&&(t.pause(),this.stopTimer=!0,this.changeControlAttributes(this.resumeBtn,"play","Resume"),this.doAction("onPause",e,t,r))}},{key:"resumeRecording",value:function(t,e,r){"paused"===t.state&&(t.resume(),this.stopTimer=!1,this.startTime=Date.now(),this.changeControlAttributes(this.startBtn,"recordAlt","Stop Recording"),this.doAction("onResume",e,t,r))}},{key:"stopRecording",value:function(t,e){t.stop(),this.videoTimeline.setAttribute("data-minutes",0),this.videoTimeline.setAttribute("data-seconds",0),this.turnOffCameraAndMic(e),clearInterval(this.timerInterval)}},{key:"deleteRecording",value:function(t,e,r){this.videoPlayerInput.src="",this.videoRecorderInput.src="",this.recorder.setAttribute("data-recording",!1),this.recorder.setAttribute("data-recorded",!1),this.doAction("onDelete",e,t,r)}},{key:"showRecorder",value:function(){this.recorder.classList.remove("masterstudy-video__recorder_hidden")}},{key:"hideRecorder",value:function(){this.recorder.classList.add("masterstudy-video__recorder_hidden")}},{key:"toggleMicrophoneSound",value:function(t){this.toggleStreamAudioSound(t,this.isMuted),this.isMuted?this.changeControlAttributes(this.microphoneBtn,"mic"):this.changeControlAttributes(this.microphoneBtn,"micMuted"),this.isMuted=!this.isMuted}},{key:"videoStream",value:function(t){var e=this;e.currentMediaStream=t,"srcObject"in e.videoRecorderInput?(e.videoRecorderInput.srcObject=t,e.videoRecorderInput.muted=!0):e.videoRecorderInput.src=window.URL.createObjectURL(t),e.videoRecorderInput.onloadedmetadata=function(t){t.target.play()};var r=new MediaRecorder(t,{mimeType:e.videoType});r.ondataavailable=function(t){t.data.size>0&&(e.startTime=Date.now(),e.videoChunks.push(t.data))},r.onstop=function(t){var i=new Blob(e.videoChunks,{type:e.videoType});e.videoChunks=[],e.videoPlayerInput.src=window.URL.createObjectURL(i),i&&i.size>0&&e.doAction("onStop",i,e.currentMediaStream,r),e.currentMediaStream=null},this.recorderControlEvents(r,t)}},{key:"recorderControlEvents",value:function(t,e){var r=this;[{btn:r.startBtn,handler:r.recordVideo},{btn:r.pauseBtn,handler:r.pauseRecording},{btn:r.resumeBtn,handler:r.resumeRecording},{btn:r.stopBtn,handler:r.stopRecording},{btn:r.deleteBtn,handler:r.deleteRecording},{btn:r.microphoneBtn,handler:r.toggleMicrophoneSound}].forEach((function(i){var o=i.btn,n=i.handler;o&&r.addRecorderEvent(o,"click",(function(i){n.call(r,t,e,i)}))}))}},{key:"startVideoStream",value:function(t){var e=this.getUserMedia(this.constraints);if(e)return e.then((function(e){return t(e),!0})).catch((function(t){return console.log(t.name,t.message),!1}))}},{key:"getUserMedia",value:function(){return void 0===window.navigator.mediaDevices&&(window.navigator.mediaDevices={},window.navigator.mediaDevices.getUserMedia=function(t){var e=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return e?new Promise((function(r,i){e.call(navigator,t,r,i)})):Promise.reject(new Error("getUserMedia is not implemented in this browser"))}),window.navigator.mediaDevices.getUserMedia(this.constraints)}},{key:"updateRecordingTime",value:function(){if(!this.stopTimer){var t=new Date(Date.now()-this.startTime),e=t.getMinutes(),r=t.getSeconds();e=e<10?"0".concat(e):e,r=r<10?"0".concat(r):r,this.videoTimeline.innerHTML="".concat(e,":").concat(r)}}},{key:"turnOffCameraAndMic",value:function(t){t&&(t.getTracks().forEach((function(t){t.stop()})),this.mediaStreamStopped=!0,t=null)}},{key:"toggleStreamAudioSound",value:function(t,e){t.stream.getAudioTracks().forEach((function(t){t.enabled=e}),e)}},{key:"setControls",value:function(t){(t=t||{}).constraints&&delete t.constraints,Object.assign(this.controls,t)}},{key:"getControl",value:function(t,e){return"string"==typeof t&&t?e?this.recorder.querySelectorAll(t):this.recorder.querySelector(t):null}},{key:"setConstraints",value:function(t){Object.assign(this.constraints,t)}},{key:"addRecorderEvent",value:function(t,e,r){t&&t.addEventListener(e,r)}},{key:"changeControlAttributes",value:function(t,e,r){(t.querySelectorAll("svg path").forEach((function(t,r){t.attributes.d.value=this.getControlcon(e)[r]||""}),this),r)&&t.querySelectorAll("span").forEach((function(t,e){Array.isArray(r)?t.innerHTML=r[e]:t.innerHTML=r}),this)}},{key:"getControlcon",value:function(t){return{record:["M8 13A5 5 0 1 0 8 3a5 5 0 0 0 0 10z"],mic:["M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z","M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"],micMuted:["M13 8c0 .564-.094 1.107-.266 1.613l-.814-.814A4.02 4.02 0 0 0 12 8V7a.5.5 0 0 1 1 0v1zm-5 4c.818 0 1.578-.245 2.212-.667l.718.719a4.973 4.973 0 0 1-2.43.923V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 1 0v1a4 4 0 0 0 4 4zm3-9v4.879L5.158 2.037A3.001 3.001 0 0 1 11 3z","M9.486 10.607 5 6.12V8a3 3 0 0 0 4.486 2.607zm-7.84-9.253 12 12 .708-.708-12-12-.708.708z"],camera:["M2.66675 3.65479C1.56218 3.65479 0.666748 4.55022 0.666748 5.65479V12.3215C0.666748 13.4261 1.56218 14.3215 2.66675 14.3215H8.66675C9.77135 14.3215 10.6667 13.4261 10.6667 12.3215V5.65479C10.6667 4.55022 9.77135 3.65479 8.66675 3.65479H2.66675ZM15.3334 6.67824V11.298C15.3334 11.8633 14.8752 12.3215 14.3099 12.3215C14.1079 12.3215 13.9103 12.2617 13.7422 12.1496L12.2969 11.1861C12.1115 11.0624 12.0001 10.8543 12.0001 10.6313V7.34491C12.0001 7.12201 12.1115 6.91385 12.2969 6.79021L13.7422 5.82667C13.9103 5.71459 14.1079 5.65479 14.3099 5.65479C14.8752 5.65479 15.3334 6.11301 15.3334 6.67824Z"],recordAlt:["M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-8 3a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"],pause:["M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z","M5 6.25a1.25 1.25 0 1 1 2.5 0v3.5a1.25 1.25 0 1 1-2.5 0v-3.5zm3.5 0a1.25 1.25 0 1 1 2.5 0v3.5a1.25 1.25 0 1 1-2.5 0v-3.5z"],play:["M0 12V4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm6.79-6.907A.5.5 0 0 0 6 5.5v5a.5.5 0 0 0 .79.407l3.5-2.5a.5.5 0 0 0 0-.814l-3.5-2.5z"]}[t]||[]}},{key:"addAction",value:function(t,e){this.recorderActions[t]||(this.recorderActions[t]=[]),this.recorderActions[t].push(e)}},{key:"doAction",value:function(t){for(var e=arguments.length,r=new Array(e>1?e-1:0),i=1;i<e;i++)r[i-1]=arguments[i];this.recorderActions[t]&&this.recorderActions[t].forEach((function(t){t.apply(void 0,r)}))}},{key:"isIOS",value:function(){return["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)}}],[{key:"init",value:function(e,r){"string"==typeof e&&e.startsWith(".")?document.querySelectorAll(e).forEach((function(e){new t(e,r)})):new t(e,r)}}]),t}();