"use strict";function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,_toPropertyKey(i.key),i)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var i=r.call(e,t||"default");if("object"!=_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}var MasterstudyAudioRecorder=function(){function e(t,r){_classCallCheck(this,e),this.recorder=t,r=r||{},"string"==typeof t&&(this.recorder=document.querySelector(t)),this.recorder&&(this.directRecording=r.directRecording||!1,this.recorder.classList.add("masterstudy-audio__recorder"),this.recorder.setAttribute("data-recorded","false"),this.recorder.setAttribute("data-recording",this.directRecording?"true":"false"),r.isHidden?this.recorder.classList.add("masterstudy-audio__recorder_hidden"):this.recorder.classList.remove("masterstudy-audio__recorder_hidden"),r.darkMode&&this.recorder.classList.add("masterstudy-audio__recorder_dark-mode"),this.controls={startBtn:".masterstudy-audio__recorder-btn_start",pauseBtn:".masterstudy-audio__recorder-btn_pause",stopBtn:".masterstudy-audio__recorder-btn_stop",controls:".masterstudy-audio__recorder-controls",activeBtn:".masterstudy-audio__recorder-btn_primary",visualizer:".masterstudy-audio__recorder-progress__visualizer",recorderState:".masterstudy-audio__recorder-state",audioTimeline:".masterstudy-audio__recorder-progress__timeline"},this.timerInterval,this.isStarted=!1,this.isResumed=!1,this.nodeNumber=16,this.constraints={audio:!0,video:!1},this.audioChunks=[],this.audioType="audio/webm",this.audioFormat="mp3",this.startTime=Date.now(),this.timerStop=!1,this.timerMinutes=0,this.timerSeconds=0,this.recorderActions=[],this.startBtn=this.getControl(this.controls.startBtn),this.stopBtn=this.getControl(this.controls.stopBtn),this.pauseBtn=this.getControl(this.controls.pauseBtn),this.resumeBtn=this.getControl(this.controls.resumeBtn),this.deleteBtn=this.getControl(this.controls.deleteBtn),this.visualizer=this.getControl(this.controls.visualizer),this.audioTimeline=this.getControl(this.controls.audioTimeline),this.recorderState=this.getControl(this.controls.recorderState),this.audioInput=this.recorder.querySelector("audio"),this.visualizerNodes=this.createVisualizerNodes())}return _createClass(e,[{key:"startRecording",value:function(){return this.startAudioStream(this.audioStream.bind(this))}},{key:"recordAudio",value:function(e,t,r){"inactive"===e.state&&(e.start(),this.setActiveControl(this.stopBtn),this.recorder.setAttribute("data-recording",!0),this.recorder.setAttribute("data-recorded",!1),this.audioVisualizer(t),this.isStarted=!0,this.timerStop=!1,this.startTime=Date.now(),this.timerInterval=setInterval(this.updateRecordingTime.bind(this),1e3),this.doAction("onRecord",t,e,r))}},{key:"pauseRecording",value:function(e,t,r){var i=media_data||{},o=i.paused_ctrl_text,a=void 0===o?"Paused":o,s=i.resume_ctrl_text,n=void 0===s?"Resume":s;switch(e.state){case"recording":e.pause(),this.setActiveControl(this.pauseBtn),this.changeControlAttributes(this.recorderState,"pause",a),this.changeControlAttributes(this.pauseBtn,"mic",n),this.audioVisualizer(t).close(),this.timerStop=!0,this.doAction("onPause",t,e,r);break;case"paused":e.resume(),this.setActiveControl(this.stopBtn),this.changeControlAttributes(this.recorderState,"record","Recording"),this.changeControlAttributes(this.pauseBtn,"pause","Pause"),this.audioVisualizer(t).resume(),this.timerStop=!1,this.isResumed=!0,this.startTime=Date.now(),this.doAction("onResume",t,e,r);break;default:console.log("Somethings went wrong.")}}},{key:"masterstudyLmsIsSafari",value:function(){var e=navigator.userAgent.toLowerCase();return e.includes("safari")&&!e.includes("chrome")}},{key:"stopRecording",value:function(e,t,r){e.stop(),t.getTracks().forEach((function(e){return e.stop()})),this.setActiveControl(this.startBtn),this.directRecording||(this.recorder.setAttribute("data-recording",!1),this.recorder.setAttribute("data-recorded",!0)),this.changeControlAttributes(this.pauseBtn,"pause","Pause"),this.changeControlAttributes(this.recorderState,"record","Recording"),this.isStarted=!1,this.timerStop=!1,this.audioVisualizer(t).close(),clearInterval(this.timerInterval),this.audioTimeline.innerHTML="00:00"}},{key:"updateVisualizer",value:function(e){var t=this,r=this;requestAnimationFrame((function(){r.updateVisualizer(e)}));var i=new Uint8Array(4*this.nodeNumber);e.getByteFrequencyData(i),this.visualizerNodes.forEach((function(e,r){e.style.setProperty("--visualizer-bar-height",i[r]/255*(1+r/t.nodeNumber))}))}},{key:"createVisualizerNodes",value:function(){var e=this;return Array.from({length:this.nodeNumber},(function(t,r){var i=document.createElement("div");return i.className=e.controls.visualizer.replace(/(?:^|\s)[#.](\w+)/g,"$1")+"-bar",i.style.animationDuration="".concat(Math.random()*(.8*r-.2)+.2,"s"),e.visualizer.appendChild(i),i}))}},{key:"audioStream",value:function(e){var t=this,r=new MediaRecorder(e,{mimeType:t.audioType});r.ondataavailable=function(e){e.data.size>0&&t.audioChunks.push(e.data)},r.onstop=function(i){var o=new Blob(t.audioChunks,{type:t.audioType});t.audioChunks=[],t.audioInput.src=window.URL.createObjectURL(o),t.doAction("beforeStop",t);var a=new AudioContext,s=new FileReader;s.onloadend=function(){var i=s.result;a.decodeAudioData(i,(function(i){var a=t.audioBufferToWav(i),s=t.audioFormat.toLowerCase(),n=o;n="wav"===s?a:n,"mp3"===s&&(1===a.channels&&(n=t.wavToMp3(1,a.sampleRate,a.data)),2===a.channels&&(n=t.wavToMp3(2,a.sampleRate,a.left,a.right))),t.audioInput.src=window.URL.createObjectURL(n),t.doAction("onStop",n,e,r)}))},s.readAsArrayBuffer(o)},t.recorderControlEvents(r,e),t.directRecording&&this.recordAudio(r,e)}},{key:"startAudioStream",value:function(e){this.audioType=this.masterstudyLmsIsSafari()?"audio/mp4":"audio/webm";var t=this.getUserMedia(this.constraints);if(t)return t.then((function(t){return e(t),!0})).catch((function(e){return console.log(e.name,e.message),!1}))}},{key:"audioVisualizer",value:function(e){var t=new AudioContext(e),r=t.createMediaStreamSource(e);if(r){var i=new AnalyserNode(t,{fftSize:Math.max(4*this.nodeNumber,32),maxDecibels:-20,minDecibels:-80,smoothingTimeConstant:.8});r.connect(i),this.updateVisualizer(i)}return t}},{key:"getUserMedia",value:function(){return void 0===window.navigator.mediaDevices&&(window.navigator.mediaDevices={},window.navigator.mediaDevices.getUserMedia=function(e){var t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return t?new Promise((function(r,i){t.call(navigator,e,r,i)})):Promise.reject(new Error("getUserMedia is not implemented in this browser"))}),window.navigator.mediaDevices.getUserMedia(this.constraints)}},{key:"recorderControlEvents",value:function(e,t){var r=this;[{btn:r.startBtn,handler:r.startRecording},{btn:r.pauseBtn,handler:r.pauseRecording},{btn:r.stopBtn,handler:r.stopRecording}].forEach((function(i){var o=i.btn,a=i.handler;o&&r.addRecorderEvent(o,"click",(function(i){i.preventDefault(),a.call(r,e,t,i)}))}))}},{key:"updateRecordingTime",value:function(){if(!this.timerStop){this.isResumed&&(this.startTime=this.startTime-(6e4*this.timerMinutes+1e3*this.timerSeconds),this.timerMinutes=0,this.timerSeconds=0,this.isResumed=!1);var e=new Date(Date.now()-this.startTime),t=e.getMinutes(),r=e.getSeconds();this.timerMinutes=t,this.timerSeconds=r,t=t<10?"0".concat(t):t,r=r<10?"0".concat(r):r,this.audioTimeline.innerHTML="".concat(t,":").concat(r)}}},{key:"addRecorderEvent",value:function(e,t,r){e&&e.addEventListener(t,r)}},{key:"getControl",value:function(e,t){return"string"==typeof e&&e?t?this.recorder.querySelectorAll(e):this.recorder.querySelector(e):e instanceof HTMLElement?e:null}},{key:"setActiveControl",value:function(e){if(e="string"==typeof e?this.getControl(e):e){var t=this.controls.activeBtn.replace(/(?:^|\s)[#.](\w+)/g,"$1");Array.from(e.parentNode.children).filter((function(t){return t!==e})).forEach((function(e){e.classList.remove(t)})),e.classList.add(t)}}},{key:"changeControlAttributes",value:function(e,t,r){(e.querySelectorAll("svg path").forEach((function(e,r){e.attributes.d.value=this.getControlcon(t)[r]||""}),this),r)&&e.querySelectorAll("span").forEach((function(e,t){e.innerHTML=Array.isArray(r)?r[t]:r}),this)}},{key:"getControlcon",value:function(e){return{record:["M8 13A5 5 0 1 0 8 3a5 5 0 0 0 0 10z"],mic:["M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z","M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"],micMuted:["M13 8c0 .564-.094 1.107-.266 1.613l-.814-.814A4.02 4.02 0 0 0 12 8V7a.5.5 0 0 1 1 0v1zm-5 4c.818 0 1.578-.245 2.212-.667l.718.719a4.973 4.973 0 0 1-2.43.923V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 1 0v1a4 4 0 0 0 4 4zm3-9v4.879L5.158 2.037A3.001 3.001 0 0 1 11 3z","M9.486 10.607 5 6.12V8a3 3 0 0 0 4.486 2.607zm-7.84-9.253 12 12 .708-.708-12-12-.708.708z"],camera:["M2.66675 3.65479C1.56218 3.65479 0.666748 4.55022 0.666748 5.65479V12.3215C0.666748 13.4261 1.56218 14.3215 2.66675 14.3215H8.66675C9.77135 14.3215 10.6667 13.4261 10.6667 12.3215V5.65479C10.6667 4.55022 9.77135 3.65479 8.66675 3.65479H2.66675ZM15.3334 6.67824V11.298C15.3334 11.8633 14.8752 12.3215 14.3099 12.3215C14.1079 12.3215 13.9103 12.2617 13.7422 12.1496L12.2969 11.1861C12.1115 11.0624 12.0001 10.8543 12.0001 10.6313V7.34491C12.0001 7.12201 12.1115 6.91385 12.2969 6.79021L13.7422 5.82667C13.9103 5.71459 14.1079 5.65479 14.3099 5.65479C14.8752 5.65479 15.3334 6.11301 15.3334 6.67824Z"],recordAlt:["M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-8 3a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"],pause:["M0 0 V14 H3.11111 V0 H0 Z M7.70776 0 V14 H10.81887 V0 H7.70776 Z"],play:["M0 12V4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm6.79-6.907A.5.5 0 0 0 6 5.5v5a.5.5 0 0 0 .79.407l3.5-2.5a.5.5 0 0 0 0-.814l-3.5-2.5z"]}[e]||[]}},{key:"showRecorder",value:function(){this.recorder.classList.remove("masterstudy-audio__recorder_hidden")}},{key:"hideRecorder",value:function(){this.recorder.classList.add("masterstudy-audio__recorder_hidden")}},{key:"addAction",value:function(e,t){this.recorderActions[e]||(this.recorderActions[e]=[]),this.recorderActions[e].push(t)}},{key:"doAction",value:function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];this.recorderActions[e]&&this.recorderActions[e].forEach((function(e){e.apply(void 0,r)}))}},{key:"audioBufferToWav",value:function(e){var t,r,i=e.numberOfChannels,o=e.length*i*2+44,a=new ArrayBuffer(o),s=new DataView(a),n=[],u=0,d=0;for(b(1179011410),b(o-8),b(1163280727),b(544501094),b(16),g(1),g(i),b(e.sampleRate),b(2*e.sampleRate*i),g(2*i),g(16),b(1635017060),b(o-d-4),t=0;t<e.numberOfChannels;t++)n.push(e.getChannelData(t));for(;d<o;){for(t=0;t<i;t++)r=0|(.5+(r=Math.max(-1,Math.min(1,n[t][u])))<0?32768*r:32767*r),s.setInt16(d,r,!0),d+=2;u++}for(var c=lamejs.WavHeader.readHeader(new DataView(a)),l=new Int16Array(a,c.dataOffset,c.dataLen/2),h=[],m=[],f=0;f<l.length;f+=2)h.push(l[f]),m.push(l[f+1]);var v=new Int16Array(h),p=new Int16Array(m),y=this.audioFormat.toLowerCase();return"mp3"===y?{channels:c.channels,sampleRate:c.sampleRate,left:v,right:p,data:l}:"wav"===y?new Blob([a],{type:"audio/wav"}):e;function g(e){s.setUint16(d,e,!0),d+=2}function b(e){s.setUint32(d,e,!0),d+=4}}},{key:"wavToMp3",value:function(e,t,r,i){for(var o=[],a=new lamejs.Mp3Encoder(e,t,128),s=r.length,n=1152,u=0;s>=n;u+=n){if(i){var d=r.subarray(u,u+n),c=i.subarray(u,u+n);h=a.encodeBuffer(d,c)}else var l=r.subarray(u,u+n),h=a.encodeBuffer(l);h.length>0&&o.push(h),s-=n}var m=a.flush();return m.length>0&&o.push(new Int8Array(m)),new Blob(o,{type:"audio/mp3"})}}]),e}();