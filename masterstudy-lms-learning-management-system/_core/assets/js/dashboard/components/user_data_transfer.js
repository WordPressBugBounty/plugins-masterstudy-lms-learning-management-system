"use strict";stm_lms_components.user_data_transfer={template:"#stm-lms-dashboard-user_data_transfer",props:["course_id"],data:function(){return{modalVisible:!1,fileTypeError:!1,isCSVExporting:!1,emptyCsvFile:!1,userDataFileName:"",importFileSize:"",userData:[],totalUsers:0,importedUsers:0,importProgress:0,importStep:0,newEnrolledUsers:[],beforeEnrolledUsers:[],notEnrolledUsers:[],incorrectEmailUsers:[],afterImport:!1}},mounted:function(){var e=this;document.addEventListener("click",this.clickOutsideModal),["dragenter","dragover","dragleave","drop"].forEach((function(t){e.$refs.uploadFileDropArea.addEventListener(t,(function(e){e.preventDefault(),e.stopPropagation()}),!1)})),["dragenter","dragover"].forEach((function(t){e.$refs.uploadFileDropArea.addEventListener(t,(function(e){e.target.classList.add("highlight")}),!1)})),["dragleave","drop"].forEach((function(t){e.$refs.uploadFileDropArea.addEventListener(t,(function(e){e.target.classList.remove("highlight")}),!1)})),e.$refs.uploadFileDropArea.addEventListener("drop",(function(t){e.fileUploadHandler(t.dataTransfer.files),e.$forceUpdate()}),!1)},methods:{uploadImportFile:function(){var e=this;e.importStep=0,e.$refs.importFileInput.click(),e.$refs.importFileInput.addEventListener("change",(function(t){e.fileUploadHandler(t.target.files)}))},fileUploadHandler:function(e){var t=this;if(t.deleteAttachedFile(),null!=e){t.$refs.importFileInput.files=e;var r=e[0];if(null!=r){var s=r.name.split(".").pop().toLowerCase();["csv"].includes(s)?(t.userDataFileName=r.name,t.importFileSize=t.setFileSize(r.size),t.readCSVFile(r).then((function(e){var r=Object.keys(e[0]||[]);["email"].every((function(e){return r.includes(e)}))&&r.length?(t.totalUsers=e.length,t.userData=e,t.importStep=1):t.emptyCsvFile=!0})).catch((function(e){console.error("Error reading CSV file:",e)}))):t.fileTypeError=!0}}},closeImportModal:function(){this.userDataFileName="",this.importStep=0,this.userData=[],this.modalVisible=!1,this.emptyCsvFile=!1,this.fileTypeError=!1,this.afterImport&&(this.$emit("studentAdded"),this.afterImport=!1)},clickOutsideModal:function(e){e.target===this.$refs.transferModal&&(this.userDataFileName="",this.importStep=0,this.userData=[],this.modalVisible=!1,this.afterImport&&(this.$emit("studentAdded"),this.afterImport=!1))},deleteAttachedFile:function(){this.userDataFileName="",this.importStep=0,this.userData=[],this.emptyCsvFile=!1,this.fileTypeError=!1},importUsers:function(){var e=this;e.importStep=2,e.beforeEnrolledUsers=[],e.newEnrolledUsers=[],e.incorrectEmailUsers=[],e.notEnrolledUsers=[],e.importProgress=0,e.userData.map((function(t){e.$http.post("".concat(stm_lms_ajaxurl,"?action=stm_lms_dashboard_import_users_to_course&nonce=").concat(stm_lms_nonces.stm_lms_dashboard_import_users_to_course),{users:[t],course_id:e.course_id}).then((function(t){var r=t.body;r.new_enrolled_users&&r.new_enrolled_users.length&&e.newEnrolledUsers.push(r.new_enrolled_users[0]),r.before_enrolled_users&&r.before_enrolled_users.length&&e.beforeEnrolledUsers.push(r.before_enrolled_users[0]),r.incorrect_email_users&&r.incorrect_email_users.length&&e.incorrectEmailUsers.push(r.incorrect_email_users[0]),r.not_enrolled_users&&r.not_enrolled_users.length&&e.notEnrolledUsers.push(r.not_enrolled_users[0]);var s=e.beforeEnrolledUsers.length,o=e.newEnrolledUsers.length,n=e.incorrectEmailUsers.length,i=e.notEnrolledUsers.length,a=s+o+i+n;e.importedUsers=e.newEnrolledUsers.length,e.importProgress=Math.round(Math.floor(a/e.totalUsers*100)),100===e.importProgress&&(0===s&&setTimeout((function(){e.importStep=3}),1500),s>0&&setTimeout((function(){e.importStep=4}),1500),(n>0||i>0)&&0===s&&0===o&&setTimeout((function(){e.importStep=5}),1500),e.afterImport=!0)})).catch((function(t){e.importStep=5,e.userDataFileName="",e.userData=[],e.emptyCsvFile=!1,e.fileTypeError=!1}))}))},exportUsers:function(){var e=this;e.isCSVExporting=!0,e.$http.post("".concat(stm_lms_ajaxurl,"?action=stm_lms_dashboard_export_course_students&nonce=").concat(stm_lms_nonces.stm_lms_dashboard_export_course_students_to_csv),{course_id:e.course_id}).then((function(t){null!==t.body.user_data&&t.body.user_data.length&&e.downloadCSV({filename:t.body.filename},t.body.user_data),setTimeout((function(){e.isCSVExporting=!1}),1500)}))},readCSVFile:function(e){return new Promise((function(t,r){var s=new FileReader;s.readAsText(e,"UTF-8"),s.onload=function(e){for(var r=e.target.result.split("\n"),s=r[0].trim().split(",").map((function(e){return e.trim()})),o=[],n=1;n<r.length;n++){for(var i=r[n].trim().split(",").map((function(e){return e.trim()})),a={},l=0;l<s.length;l++){var d=s[l];void 0!==i[l]&&""!==i[l]&&(a[d]=i[l])}Object.keys(a).length>0&&o.push(a)}t(o)},s.onerror=function(e){r(e)}}))},downloadCSV:function(e,t){var r,s,o,n="",i=this.convertArrayofObjectsToCSV({data:t});null!=i&&(s=e.filename||"students.csv",i.match(/^data:text\/csv/i)||(n="data:text/csv;charset=utf-8,"),r=encodeURI(n)+"\ufeff"+encodeURI(i),(o=document.createElement("a")).setAttribute("href",r),o.setAttribute("download",s),o.click())},convertArrayofObjectsToCSV:function(e){var t,r,s,o,n;return null!=(n=e.data||null)&&n.length?(s=e.columnDelimeter||",",o=e.lineDelimeter||"\r\n",r=Object.keys(n[0]),t="",t+=r.join(s),t+=o,n.forEach((function(e){r.forEach((function(r,o){o>0&&(t+=s+" "),t+=e[r]||""})),t+=o})),t):null},setFileSize:function(e){var t=1024,r=1048576,s=1024*r;return e>=s?(e/s).toFixed(2)+" gb":e>=r?(e/r).toFixed(2)+" mb":e>=t||e/t<1?(e/t).toFixed(2)+" kb":e+" bytes"}}};