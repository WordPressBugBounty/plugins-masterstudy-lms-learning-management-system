"use strict";!function(t){t(document).ready((function(){var e=t('[data-id="import-students-via-csv"]'),n=t(".masterstudy-manage-students-import__modal"),s=t(".masterstudy-manage-students-import__modal-close"),a=t('[data-id="add-student"]'),r=t(".masterstudy-manage-students-import__file-upload"),i=t(".masterstudy-manage-students-import__file-upload__field"),o=t(".masterstudy-manage-students-import__file-upload__input"),d=t(".masterstudy-manage-students-import__adding-box__icon-wrapper"),u=t(".masterstudy-manage-students-import__adding-box__icon"),l=t(".masterstudy-manage-students-import__email-input"),m=t(".masterstudy-manage-students-import__list"),c=n.attr("data-course-id"),p=t(".masterstudy-progress"),f=[],_=1,v=0,g=0,h=[],y=!1;function C(e){if(null!=e){var n=e[0];if(null!=n){var s,a,r,o,d=n.name.split(".").pop().toLowerCase();if(!["csv"].includes(d))return i.addClass("error"),void t(".masterstudy-manage-students-import__unsupported-file-type").removeClass("hidden");t(".masterstudy-manage-students-import__file-attachment__title").text(n.name),t(".masterstudy-manage-students-import__file-attachment__size").text((s=n.size)>=(o=1024*(r=1024*(a=1024)))?(s/o).toFixed(2)+" gb":s>=r?(s/r).toFixed(2)+" mb":s>=a||s/a<1?(s/a).toFixed(2)+" kb":s+" bytes"),function(t){return v=0,g=0,h={},new Promise((function(e,n){var s=new FileReader;s.readAsText(t,"UTF-8"),s.onload=function(t){for(var n=t.target.result.split("\n"),s=n[0].trim().split(",").map((function(t){return t.trim()})),a=[],r=1;r<n.length;r++){for(var i=n[r].trim().split(",").map((function(t){return t.trim()})),o={},d=0;d<s.length;d++){var u=s[d];void 0!==i[d]&&""!==i[d]&&(o[u]=i[d])}Object.keys(o).length>0&&a.push(o)}e(a)},s.onerror=function(t){n(t)}}))}(n).then((function(e){var n=["email"],s=Object.keys(e[0]||[]),a=n.every((function(t){return s.includes(t)}));!a&&s.length&&(a=n.every((function(t){return s[0].split(";").includes(t)}))),a&&s.length>0&&e.length>0?(v=e.length,h=e,k(2)):(i.addClass("error"),t(".masterstudy-manage-students-empty-file").removeClass("hidden"))})).catch((function(t){console.error("Error reading CSV file:",t)}))}}}function b(){o.val(""),l.val(""),k(1),y=!1,f=[],i.removeClass("error"),u.removeClass("envelope"),t(".masterstudy-manage-students-empty-file").addClass("hidden"),t(".masterstudy-button").removeClass("masterstudy-button_loading"),t(".masterstudy-manage-students-import__unsupported-file-type").addClass("hidden"),d.removeClass("error"),m.html("")}function k(e){var s=n.find("[data-step]");_=e,s.each((function(n,s){-1!==t(s).attr("data-step").split(",").map((function(t){return parseInt(t,10)})).indexOf(e)?t(s).removeClass("hidden"):t(s).addClass("hidden"),1===e?(o.val(""),t('[data-id="import-students-submit"]').addClass("masterstudy-button_disabled")):t('[data-id="import-students-submit"]').removeClass("masterstudy-button_disabled")}))}function x(){var e=new URLSearchParams(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).toString(),n="".concat(ms_lms_resturl,"/student/").concat(c,"/?").concat(e);fetch(n,{method:"POST",headers:{"X-WP-Nonce":ms_lms_nonce,"Content-Type":"application/json"}}).then((function(t){if(t.ok)return t.json()})).then((function(e){if(e){g+=1;var n=Math.round(g/v*100,0);p.find(".masterstudy-progress__bar-filled").css({width:"".concat(n,"%")}),p.find(".masterstudy-progress__percent").text(n),e.is_enrolled_before&&f.push(e),g===v&&setTimeout((function(){!function(t){document.dispatchEvent(new CustomEvent("msAddStudentEvent",{detail:{progress:t}}))}(n),function(){if(u.removeClass("envelope"),y)return k(8),void(y=!1);k(4),t(".masterstudy-manage-students-import__user-count").text(v),f.length&&(t(".masterstudy-manage-students-import__user-count").text(v-f.length),f.map((function(t){m.append('<span class="masterstudy-manage-students-import__list-item">'.concat(t.email,"</span>"))})),k(6))}()}),1500)}else k(5),d.addClass("error")})).catch((function(t){k(5),d.addClass("error")}))}k(1),e.on("click",(function(t){t.preventDefault(),n.addClass("is-open")})),t(window).on("click",(function(e){t(e.target).is(n)&&(n.removeClass("is-open"),b())})),s.on("click",(function(t){t.preventDefault(),n.removeClass("is-open"),b()})),r.on("dragover",(function(t){t.preventDefault(),t.stopPropagation(),i.addClass("highlight")})),r.on("dragleave",(function(t){t.preventDefault(),t.stopPropagation(),i.removeClass("highlight")})),r.on("drop",(function(t){t.preventDefault(),t.stopPropagation(),i.removeClass("highlight"),C(t.originalEvent.dataTransfer.files)})),t('[data-id="import-students-upload-csv-btn"]').on("click",(function(){o.click()})),t(".masterstudy-manage-students-import__file-attachment__delete").on("click",(function(){o.val(""),k(1)})),t('[data-id="import-students-close-modal"]').on("click",(function(){n.removeClass("is-open"),b()})),t('[data-id="import-students-next-attempt"]').on("click",(function(){o.val(""),k(1),i.removeClass("error"),t(".masterstudy-manage-students-import__unsupported-file-type").addClass("hidden"),d.removeClass("error")})),o.on("change",(function(t){C(t.target.files)})),t('[data-id="import-students-submit"]').on("click",(function(t){t.preventDefault(),1!==_&&(k(3),h.map((function(t){x(t)})))})),a.on("click",(function(t){t.preventDefault(),k(7),v=1,g=0,y=!0,u.addClass("envelope"),n.addClass("is-open")})),t('[data-id="send-invitation"]').on("click",(function(e){e.preventDefault();var n=l.val();!function(t){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)}(n)?t(".masterstudy-manage-students-import__incorrect-email").removeClass("hidden"):(t(this).addClass("masterstudy-button_loading"),x({email:n}))})),l.on("change paste keyup",(function(){t(".masterstudy-manage-students-import__incorrect-email").addClass("hidden")}))}))}(jQuery);