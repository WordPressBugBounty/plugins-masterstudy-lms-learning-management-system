"use strict";!function(s){s(document).ready((function(){s("body").addClass("stm_lms_chat_page"),new Vue({el:"#stm_lms_chat",data:function(){return{conversations:[],conversation:"",myMessage:"",myResponse:"",loading:!1,updating:!1,instructorPublic:chat_data.instructor_public,studentPublic:chat_data.student_public}},mounted:function(){this.getConversation(!1)},methods:{updateConversation:function(){var s=this;s.updating=!0,s.getMessages(s.conversations[s.conversation].conversation_info.conversation_id,!0)},getConversation:function(s){var n=this,t=stm_lms_ajaxurl+"?action=stm_lms_get_user_conversations&nonce="+stm_lms_nonces.stm_lms_get_user_conversations;this.$http.get(t).then((function(s){s.body.forEach((function(s,t){n.conversations.push(s)})),n.conversations.length&&(n.conversation=0)}))},getMessages:function(s,n,t){var e=this,o=stm_lms_ajaxurl+"?action=stm_lms_get_user_messages&nonce="+stm_lms_nonces.stm_lms_get_user_messages+"&id="+s+"&just_send="+t;if(void 0!==e.conversations[e.conversation].messages&&!n)return e.scrollMessagesBottom(),!1;e.conversations[e.conversation].length||this.$http.get(o).then((function(s){e.$set(e.conversations[e.conversation],"messages",s.body.messages),e.scrollMessagesBottom()}))},changeChat:function(s){this.conversation=s;var n=this;["uf_new_messages","ut_new_messages"].forEach((function(t){n.conversations[s].conversation_info[t]>0&&(n.conversations[s].conversation_info[t]=0)}));var t=stm_lms_ajaxurl+"?action=stm_lms_clear_new_messages&nonce="+stm_lms_nonces.stm_lms_clear_new_messages+"&conversation_id="+n.conversations[n.conversation].conversation_info.conversation_id;n.$http.get(t).then((function(s){})).catch((function(s){n.scrollMessagesBottom()}))},scrollMessagesBottom:function(){var s=this;this.updating=!1,this.$nextTick((function(){var n=s.$el.querySelector("#stm_lms_chat_messages");n.scrollTop=n.scrollHeight}))},sendMessage:function(){var s=this;s.loading=!0;var n=s.conversations[s.conversation].companion.id;if(s.myMessage){var t={to:n,message:s.myMessage},e=stm_lms_ajaxurl+"?action=stm_lms_send_message&nonce="+stm_lms_nonces.stm_lms_send_message;s.loading=!0,this.$http.post(e,t).then((function(n){s.getMessages(s.conversations[s.conversation].conversation_info.conversation_id,!0,!0),n.body.response&&"error"===n.body.status&&(s.myResponse=n.body.response),s.myMessage="",s.loading=!1}))}}},watch:{conversation:function(s){s=this.conversations[s].conversation_info.conversation_id,this.getMessages(s,!1,!0)}}})}))}(jQuery);